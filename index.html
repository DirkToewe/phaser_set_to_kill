<!doctype html> 
<html lang="en"> 

  <head> 
    <meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 1</title>
    <script src="//cdn.jsdelivr.net/phaser/2.6.1/phaser.js"></script>
    <style type="text/css">
      body {
        margin: 0;
      }
    </style>
  </head>

  <body>
    <script type="text/javascript">
      var game = new Phaser.Game(512, 1.5*512, Phaser.AUTO, '', { preload: preload, create: create, update: update });
      var score = 0;
      var scoreText;
      var background, fighter, bullets, enemies;
      var input;

      function create()
      {
        game.physics.startSystem(Phaser.Physics.ARCADE);

        var world = game.world;
        world.scale.setTo(2,2);
        world.width  =     256;
        world.height = 1.5*256;

        background = game.add.tileSprite(0, 0, world.width, world.height, 'background-desert');

        fighter = game.add.sprite(128-8, 256+64, 'fighter');
        game.physics.arcade.enable(fighter);
        fighter.texture.baseTexture.scaleMode = PIXI.scaleModes.NEAREST;
        fighter.body.collideWorldBounds = true;

        enemies = game.add.group();
        enemies.enableBody = true;

        bullets = game.add.group();
        bullets.enableBody = true;

        scoreText = game.add.text(8, 8, 'Score: 0', { fontSize: '24px', fill: '#FFF' });

        input      = game.input.keyboard.createCursorKeys();
        input.fire = game.input.keyboard.addKey(Phaser.KeyCode.SPACEBAR);

        game.time.events.loop(Phaser.Timer.SECOND,    addFighters,      this);
        game.time.events.loop(Phaser.Timer.SECOND/30, cannon,           this);
        game.time.events.loop(Phaser.Timer.SECOND/10, fighterAnimation, this);
      }

      function cannon()
      {
        // TODO move this somewhere else
        if( input.fire.isDown )
        {
          bullet = game.add.sprite( fighter.x, fighter.y, 'laser-bolts' );
          bullet.texture.baseTexture.scaleMode = PIXI.scaleModes.NEAREST;
          bullets.add(bullet);
          bullet.body.velocity.y = -300;
          bullet.outOfBoundsKill = true;
          bullet.frame = 2;
        }
      }

      function addFighters()
      {
        roll = game.rnd.integerInRange(0,99);
        var enemy;
        if( roll < 20 ) {
          enemy = game.add.sprite( game.rnd.integerInRange(16,128-16), 0, 'enemy-big' );
          enemies.add(enemy);
          enemy.body.velocity.y = 20;
        }
        else if( roll < 40 ) {
          enemy = game.add.sprite( game.rnd.integerInRange(16,128-16), 0, 'enemy-medium' );
          enemies.add(enemy);
          enemy.body.velocity.y = 40;
        }
        else if( roll < 80 ) {
          enemy = game.add.sprite( game.rnd.integerInRange(16,128-16), 0, 'enemy-small' );
          enemies.add(enemy);
          enemy.body.velocity.y = 80;
        }
        else return;
        enemy.outOfBoundsKill = true;
        enemy.texture.baseTexture.scaleMode = PIXI.scaleModes.NEAREST;
      }

      function enemyHit(bullet,enemy)
      {
        score += 1;
        scoreText.setText('Score: '+score);
        bullet.kill();
        enemy.kill();
        explosion = game.add.sprite(enemy.x, enemy.y, 'explosion');
        explosion.animations.add('explode', [0,1,2,3,4], 8);
        explosion.animations.play('explode');
        game.time.events.add(Phaser.Timer.SECOND/8*5, explosion.kill, explosion)
      }

      function fighterAnimation()
      {
        fighter.frame += 5;
        fighter.frame %= 10;
      }

      function update()
      {
        if     ( input.up  .isDown ) fighter.body.gravity.y =-128;
        else if( input.down.isDown ) fighter.body.gravity.y =+128;
        else                         fighter.body.gravity.y = 0;

        if     ( input.left .isDown ) fighter.body.gravity.x =-128;
        else if( input.right.isDown ) fighter.body.gravity.x =+128;
        else                          fighter.body.gravity.x = 0;

        game.physics.arcade.overlap(bullets,enemies,enemyHit);

        background.tilePosition.y += 2;
      }

      function preload()
      {
        game.load.image('background-clouds', 'assets/backgrounds/clouds.png');
        game.load.image('background-desert', 'assets/backgrounds/desert-background.png', 256, 272);

        game.load.spritesheet('enemy-big',   'assets/spritesheets/enemy-big.png',    32, 32);
        game.load.spritesheet('enemy-medium','assets/spritesheets/enemy-medium.png', 32, 16);
        game.load.spritesheet('enemy-small', 'assets/spritesheets/enemy-small.png',  16, 16);
        game.load.spritesheet('explosion',   'assets/spritesheets/explosion.png',    16, 16);
        game.load.spritesheet('laser-bolts', 'assets/spritesheets/laser-bolts.png',  16, 16);
        game.load.spritesheet('power-up',    'assets/spritesheets/power-up.png',     16, 16);
        game.load.spritesheet('fighter',     'assets/spritesheets/ship.png',         16, 24);
      }
    </script>
  </body>

</html>
