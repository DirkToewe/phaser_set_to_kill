<!doctype html> 
<html lang="en"> 

  <head> 
    <meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 1</title>
    <script src="//cdn.jsdelivr.net/phaser/2.6.1/phaser.js"></script>
    <style type="text/css">
      body {
        margin: 0;
      }
    </style>
  </head>

  <body>
    <script type="text/javascript">
      'use strict';
      var game = new Phaser.Game(512, 1.5*512, Phaser.AUTO, '', { preload: preload, create: create, update: update });
      var score = 0;
      var scoreText, fpsText;
      var background, fighter, cannon, enemies, explosions;
      var input;

      function create()
      {
        game.time.advancedTiming = true;
        game.time.desiredFps = 60;
        game.physics.startSystem(Phaser.Physics.ARCADE);

        var world = game.world;
        world.scale.set(2);
        world.width  =     256;
        world.height = 1.5*256;

        background = game.add.tileSprite(0, 0, world.width, world.height, 'background-desert');
        background.autoScroll(0,32);

        fighter = game.add.sprite(128-8, 256+64, 'fighter');
        game.physics.arcade.enable(fighter);
        fighter.texture.baseTexture.scaleMode = PIXI.scaleModes.NEAREST;
        fighter.body.collideWorldBounds = true;

        enemies = {};
        enemies.small  = game.add.group();
        enemies.medium = game.add.group();
        enemies.big    = game.add.group();
        enemies.small .enableBody = true;
        enemies.medium.enableBody = true;
        enemies.big   .enableBody = true;
        function createEnemies(count,size)
        {
          for( var i = 0; i < count; i++ )
          {
            var enemy = game.add.sprite( 0, 0, 'enemy-'+size );
            enemies[size].add(enemy);
            enemy.checkWorldBounds = true;
            enemy.outOfBoundsKill = true;
            enemy.texture.baseTexture.scaleMode = PIXI.scaleModes.NEAREST;
            enemy.exists = false;
          }
        }
        createEnemies( 256,'small');
        createEnemies( 128,'medium');
        createEnemies(  64,'big');

        explosions = game.add.group();
        for( var i = 0; i < 512; i++ )
        {
          var explosion = game.add.sprite( 0, 0, 'explosion' );
          explosions.add(explosion);
          explosion.checkWorldBounds = true;
          explosion.outOfBoundsKill = true;
          explosion.texture.baseTexture.scaleMode = PIXI.scaleModes.NEAREST;
          explosion.exists = false;
        }

        cannon = new Weapon.SingleBullet(game);

        scoreText = game.add.text(8,      8, 'Score: 0', { fontSize: '24px', fill: '#FFF' });
          fpsText = game.add.text(128+32, 8, 'FPS: 0',   { fontSize: '24px', fill: '#FFF' });

        input       = game.input.keyboard.createCursorKeys();
        input.fire  = game.input.keyboard.addKey(Phaser.KeyCode.SPACEBAR);
        input.mouse = game.input.mousePointer;
        input.touch = game.input.pointer1;

        game.scale.fullScreenScaleMode = Phaser.ScaleManager.SHOW_ALL;
        function toggleFullScreen()
        {
          if (game.scale.isFullScreen)
            game.scale.stopFullScreen();
          else
            game.scale.startFullScreen(false);
        }

        game.input.addPointer();
        var enter = game.input.keyboard.addKey(Phaser.KeyCode.ENTER);
        game.input.onDown.add(
          function(pointer)
          {
            if( pointer.id === 3 )
              toggleFullScreen();
          }
        );
        enter.onDown.add(toggleFullScreen);

        game.time.events.loop(Phaser.Timer.SECOND/10,  updateExplosions, this);
        game.time.events.loop(Phaser.Timer.SECOND/200, addEnemy,         this);
        game.time.events.loop(Phaser.Timer.SECOND/10,  fighterAnimation, this);
      }

      function addEnemy()
      {
        var roll = game.rnd.integerInRange(0,99);
        var enemy;
        if( roll < 20 ) {
          enemy = enemies.big.getFirstExists(false);
          enemy.reset(game.rnd.integerInRange(16,256-16), 0);
          enemy.body.velocity.y = 100;
        }
        else if( roll < 40 ) {
          enemy = enemies.medium.getFirstExists(false);
          enemy.reset(game.rnd.integerInRange(16,256-16), 0);
          enemy.body.velocity.y = 200;
        }
        else if( roll < 80 ) {
          enemy = enemies.small.getFirstExists(false);
          enemy.reset(game.rnd.integerInRange(16,256-16), 0);
          enemy.body.velocity.y = 400;
        }
        else return;
      }

      function enemyHit(bullet,enemy)
      {
        if( bullet.alive )
        {
          score += 1;
          bullet.kill();
          enemy.kill();
          var explosion = explosions.getFirstExists(false);
          explosion.reset(enemy.x, enemy.y);
          explosion.frame = 0;
        }
      }

      function updateExplosions()
      {
        explosions.forEachAlive(
          function(explosion)
          {
            if( 4 === explosion.frame )
              explosion.kill();
            else
              explosion.frame += 1;
          }
        );
      }

      function fighterAnimation()
      {
        fighter.frame += 5;
        fighter.frame %= 10;
      }

      function update()
      {
        fpsText.setText('FPS: '+game.time.fps);
        scoreText.setText('Score: '+score);

        function handlePointer(pointer,yOff)
        {
          fighter.body.velocity.x = Math.min(+512,Math.max(-512, 32*(pointer.x/game.world.scale.x - fighter.x) ));
          fighter.body.velocity.y = Math.min(+512,Math.max(-512, 32*(pointer.y/game.world.scale.y - fighter.y-yOff) ));
          cannon.fire(fighter);  
        }
             if( input.touch.isDown ) handlePointer(input.touch,64);
        else if( input.mouse.isDown ) handlePointer(input.mouse,0);
        else {
          if     ( input.up  .isDown ) fighter.body.velocity.y =-512;
          else if( input.down.isDown ) fighter.body.velocity.y =+512;
          else                         fighter.body.velocity.y = 0;

          if     ( input.left .isDown ) fighter.body.velocity.x =-512;
          else if( input.right.isDown ) fighter.body.velocity.x =+512;
          else                          fighter.body.velocity.x = 0;
        }

        if     ( input.fire.isDown ) cannon.fire(fighter);

        game.physics.arcade.overlap(cannon,enemies.small, enemyHit);
        game.physics.arcade.overlap(cannon,enemies.medium,enemyHit);
        game.physics.arcade.overlap(cannon,enemies.big,   enemyHit);
      }

      function preload()
      {
        game.load.image('background-clouds', 'assets/backgrounds/clouds.png');
        game.load.image('background-desert', 'assets/backgrounds/desert-background.png', 256, 272);

        game.load.spritesheet('enemy-big',   'assets/spritesheets/enemy-big.png',    32, 32);
        game.load.spritesheet('enemy-medium','assets/spritesheets/enemy-medium.png', 32, 16);
        game.load.spritesheet('enemy-small', 'assets/spritesheets/enemy-small.png',  16, 16);
        game.load.spritesheet('explosion',   'assets/spritesheets/explosion.png',    16, 16);
        game.load.spritesheet('laser-bolts', 'assets/spritesheets/laser-bolts.png',  16, 16);
        game.load.spritesheet('power-up',    'assets/spritesheets/power-up.png',     16, 16);
        game.load.spritesheet('fighter',     'assets/spritesheets/ship.png',         16, 24);
      }

      var Weapon = {};
      Weapon.SingleBullet = function (game) {
        Phaser.Group.call(this, game, game.world, 'Single Bullet', false, true, Phaser.Physics.ARCADE);
        this.nextFire = 0;
        this.bulletSpeed = 800;
        this.fireRate = 10;
        for( var i = 0; i < 256; i++ )
          this.add( new Bullet(game,'laser-bolts'), true );
        return this;
      };
      Weapon.SingleBullet.prototype = Object.create(Phaser.Group.prototype);
      Weapon.SingleBullet.prototype.constructor = Weapon.SingleBullet;
      Weapon.SingleBullet.prototype.fire = function (source) {
        if (this.game.time.time < this.nextFire) { return; }
        var x = source.x;
        var y = source.y;
        this.getFirstExists(false).fire(x, y, -95,   this.bulletSpeed);
        this.getFirstExists(false).fire(x, y, -92.5, this.bulletSpeed);
        this.getFirstExists(false).fire(x, y, -90,   this.bulletSpeed);
        this.getFirstExists(false).fire(x, y, -87.5, this.bulletSpeed);
        this.getFirstExists(false).fire(x, y, -85,   this.bulletSpeed);
        this.nextFire = this.game.time.time + this.fireRate;
      };



      function Bullet(game, asset)
      {
        Phaser.Sprite.call(this, game, 0, 0, asset);
        this.texture.baseTexture.scaleMode = PIXI.scaleModes.NEAREST;
//        this.anchor.set(0.5);
        this.checkWorldBounds = true;
        this.outOfBoundsKill = true;
        this.exists = false;
        this.tracking = false;
//        this.frame = 2;
      }
      Bullet.prototype = Object.create(Phaser.Sprite.prototype);
      Bullet.prototype.constructor = Bullet;
      Bullet.prototype.fire = function (x, y, angle, speed)
      {
        this.reset(x,y);
        this.game.physics.arcade.velocityFromAngle(angle, speed, this.body.velocity);
        this.angle = angle;
      };
      Bullet.prototype.update = function () {};
    </script>
  </body>

</html>
